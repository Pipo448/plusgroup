// ============================================================
// PLUS GROUP — Innov@tion & Tech | Prisma Schema
// ============================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// ENUMS
// ============================================================

enum TenantStatus {
  pending
  active
  suspended
  cancelled
}

enum DefaultCurrency {
  HTG
  USD
}

enum DefaultLanguage {
  ht
  fr
  en
}

enum UserRole {
  admin
  cashier
  stock_manager
  viewer
}

enum QuoteStatus {
  draft
  sent
  accepted
  converted
  cancelled
  expired
}

enum InvoiceStatus {
  unpaid
  partial
  paid
  cancelled
  refunded
}

enum PaymentMethod {
  cash
  card
  transfer
  moncash
  natcash
  check
  other
}

enum StockMovementType {
  sale
  purchase
  adjustment
  return_item
  loss
  transfer
}

// ============================================================
// SUPER ADMIN
// ============================================================

model SuperAdmin {
  id           String   @id @default(uuid())
  name         String   @db.VarChar(100)
  email        String   @unique @db.VarChar(150)
  passwordHash String   @map("password_hash")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  tenants Tenant[]

  @@map("super_admins")
}

model SubscriptionPlan {
  id           String   @id @default(uuid())
  name         String   @db.VarChar(100)
  nameFr       String?  @map("name_fr") @db.VarChar(100)
  nameEn       String?  @map("name_en") @db.VarChar(100)
  maxUsers     Int      @default(5) @map("max_users")
  maxProducts  Int      @default(500) @map("max_products")
  priceMonthly Decimal  @map("price_monthly") @db.Decimal(10, 2)
  priceAnnual  Decimal? @map("price_annual") @db.Decimal(10, 2)
  features     Json     @default("[]")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  tenants       Tenant[]
  subscriptions TenantSubscription[]

  @@map("subscription_plans")
}

// ============================================================
// TENANTS (ENTREPRISES)
// ============================================================

model Tenant {
  id                  String          @id @default(uuid())
  name                String          @db.VarChar(200)
  slug                String          @unique @db.VarChar(100)
  logoUrl             String?         @map("logo_url")
  primaryColor        String?         @default("#1E40AF") @map("primary_color") @db.VarChar(7)
  address             String?
  phone               String?         @db.VarChar(50)
  email               String?         @db.VarChar(150)
  website             String?         @db.VarChar(200)
  defaultCurrency     DefaultCurrency @default(HTG) @map("default_currency")
  exchangeRates       String?         @default("{}")
  visibleCurrencies   String?         @default("[\"USD\"]")
  showExchangeRate    Boolean         @default(false)
  defaultLanguage     DefaultLanguage @default(ht) @map("default_language")
  exchangeRate        Decimal         @default(125.00) @map("exchange_rate") @db.Decimal(10, 4)
  taxRate             Decimal         @default(0) @map("tax_rate") @db.Decimal(5, 2)
  receiptSize         String          @default("80mm") @map("receipt_size") @db.VarChar(10)  // ✅ "80mm" oswa "57mm"
  printerConnection   String          @default("usb") @map("printer_connection") @db.VarChar(20)
  planId              String?         @map("plan_id")
  status              TenantStatus    @default(pending)
  trialEndsAt         DateTime?       @map("trial_ends_at")
  subscriptionEndsAt  DateTime?       @map("subscription_ends_at")
  createdBy           String?         @map("created_by")
  createdAt           DateTime        @default(now()) @map("created_at")
  updatedAt           DateTime        @updatedAt @map("updated_at")

  plan              SubscriptionPlan?    @relation(fields: [planId], references: [id])
  creator           SuperAdmin?          @relation(fields: [createdBy], references: [id])
  subscriptions     TenantSubscription[]
  users             User[]
  productCategories ProductCategory[]
  products          Product[]
  clients           Client[]
  quotes            Quote[]
  quoteItems        QuoteItem[]
  invoices          Invoice[]
  invoiceItems      InvoiceItem[]
  payments          Payment[]
  stockMovements    StockMovement[]
  documentSequences DocumentSequence[]
  activityLogs      ActivityLog[]
  notifications     Notification[]

  @@map("tenants")
}

model TenantSubscription {
  id           String   @id @default(uuid())
  tenantId     String   @map("tenant_id")
  planId       String   @map("plan_id")
  billingCycle String?  @map("billing_cycle") @db.VarChar(10)
  amountPaid   Decimal? @map("amount_paid") @db.Decimal(10, 2)
  currency     String   @default("USD") @db.VarChar(3)
  startsAt     DateTime @map("starts_at")
  endsAt       DateTime @map("ends_at")
  paymentRef   String?  @map("payment_ref") @db.VarChar(200)
  notes        String?
  createdAt    DateTime @default(now()) @map("created_at")

  tenant Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plan   SubscriptionPlan @relation(fields: [planId], references: [id])

  @@map("tenant_subscriptions")
}

// ============================================================
// USERS
// ============================================================

model User {
  id                   String          @id @default(uuid())
  tenantId             String          @map("tenant_id")
  fullName             String          @map("full_name") @db.VarChar(150)
  email                String          @db.VarChar(150)
  passwordHash         String          @map("password_hash")
  phone                String?         @db.VarChar(50)
  avatarUrl            String?         @map("avatar_url")
  role                 UserRole        @default(cashier)
  permissions          Json            @default("{}")
  preferredLang        DefaultLanguage @default(ht) @map("preferred_lang")
  isActive             Boolean         @default(true) @map("is_active")
  lastLoginAt          DateTime?       @map("last_login_at")
  passwordResetToken   String?         @map("password_reset_token")
  passwordResetExpires DateTime?       @map("password_reset_expires")
  createdBy            String?         @map("created_by")
  createdAt            DateTime        @default(now()) @map("created_at")
  updatedAt            DateTime        @updatedAt @map("updated_at")

  tenant          Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  products        Product[]
  clients         Client[]
  quotesCreated   Quote[]         @relation("QuoteCreatedBy")
  invoicesCreated Invoice[]       @relation("InvoiceCreatedBy")
  invoicesCancelled Invoice[]     @relation("InvoiceCancelledBy")
  payments        Payment[]
  stockMovements  StockMovement[]
  activityLogs    ActivityLog[]
  notifications   Notification[]

  @@unique([tenantId, email])
  @@map("users")
}

// ============================================================
// PRODUCTS & CATEGORIES
// ============================================================

model ProductCategory {
  id          String   @id @default(uuid())
  tenantId    String   @map("tenant_id")
  name        String   @db.VarChar(100)
  nameFr      String?  @map("name_fr") @db.VarChar(100)
  nameEn      String?  @map("name_en") @db.VarChar(100)
  description String?
  color       String?  @db.VarChar(7)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  products Product[]

  @@unique([tenantId, name])
  @@map("product_categories")
}

model Product {
  id             String   @id @default(uuid())
  tenantId       String   @map("tenant_id")
  categoryId     String?  @map("category_id")
  code           String?  @db.VarChar(100)
  name           String   @db.VarChar(200)
  nameFr         String?  @map("name_fr") @db.VarChar(200)
  nameEn         String?  @map("name_en") @db.VarChar(200)
  description    String?
  unit           String   @default("unité") @db.VarChar(50)
  priceHtg       Decimal  @default(0) @map("price_htg") @db.Decimal(12, 2)
  priceUsd       Decimal  @default(0) @map("price_usd") @db.Decimal(12, 2)
  costPriceHtg   Decimal  @default(0) @map("cost_price_htg") @db.Decimal(12, 2)
  quantity       Decimal  @default(0) @db.Decimal(12, 3)
  alertThreshold Decimal  @default(5) @map("alert_threshold") @db.Decimal(12, 3)
  imageUrl       String?  @map("image_url")
  isActive       Boolean  @default(true) @map("is_active")
  isService      Boolean  @default(false) @map("is_service")
  createdBy      String?  @map("created_by")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  tenant        Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  category      ProductCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  creator       User?           @relation(fields: [createdBy], references: [id])
  quoteItems    QuoteItem[]
  invoiceItems  InvoiceItem[]
  stockMovements StockMovement[]

  @@unique([tenantId, code])
  @@map("products")
}

// ============================================================
// CLIENTS
// ============================================================

model Client {
  id                String          @id @default(uuid())
  tenantId          String          @map("tenant_id")
  clientType        String          @default("individual") @map("client_type") @db.VarChar(20)
  name              String          @db.VarChar(200)
  companyName       String?         @map("company_name") @db.VarChar(200)
  email             String?         @db.VarChar(150)
  phone             String?         @db.VarChar(50)
  phone2            String?         @db.VarChar(50)
  address           String?
  city              String?         @db.VarChar(100)
  nif               String?         @db.VarChar(50)
  creditLimit       Decimal         @default(0) @map("credit_limit") @db.Decimal(12, 2)
  balance           Decimal         @default(0) @db.Decimal(12, 2)
  preferredCurrency DefaultCurrency @default(HTG) @map("preferred_currency")
  notes             String?
  isActive          Boolean         @default(true) @map("is_active")
  createdBy         String?         @map("created_by")
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")

  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  creator  User?     @relation(fields: [createdBy], references: [id])
  quotes   Quote[]
  invoices Invoice[]

  @@map("clients")
}

// ============================================================
// QUOTES (DEVIS)
// ============================================================

model Quote {
  id               String          @id @default(uuid())
  tenantId         String          @map("tenant_id")
  quoteNumber      String          @map("quote_number") @db.VarChar(50)
  clientId         String?         @map("client_id")
  clientSnapshot   Json            @map("client_snapshot")
  currency         DefaultCurrency @default(HTG)
  exchangeRate     Decimal         @map("exchange_rate") @db.Decimal(10, 4)
  subtotalHtg      Decimal         @default(0) @map("subtotal_htg") @db.Decimal(14, 2)
  subtotalUsd      Decimal         @default(0) @map("subtotal_usd") @db.Decimal(14, 2)
  discountType     String          @default("amount") @map("discount_type") @db.VarChar(10)
  discountValue    Decimal         @default(0) @map("discount_value") @db.Decimal(10, 2)
  discountHtg      Decimal         @default(0) @map("discount_htg") @db.Decimal(14, 2)
  discountUsd      Decimal         @default(0) @map("discount_usd") @db.Decimal(14, 2)
  taxRate          Decimal         @default(0) @map("tax_rate") @db.Decimal(5, 2)
  taxHtg           Decimal         @default(0) @map("tax_htg") @db.Decimal(14, 2)
  taxUsd           Decimal         @default(0) @map("tax_usd") @db.Decimal(14, 2)
  totalHtg         Decimal         @default(0) @map("total_htg") @db.Decimal(14, 2)
  totalUsd         Decimal         @default(0) @map("total_usd") @db.Decimal(14, 2)
  status           QuoteStatus     @default(draft)
  issueDate        DateTime        @default(now()) @map("issue_date") @db.Date
  expiryDate       DateTime?       @map("expiry_date") @db.Date
  notes            String?
  terms            String?
  createdBy        String?         @map("created_by")
  convertedToInvoiceId String?     @map("converted_to_invoice_id")
  convertedAt      DateTime?       @map("converted_at")
  createdAt        DateTime        @default(now()) @map("created_at")
  updatedAt        DateTime        @updatedAt @map("updated_at")

  tenant  Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client  Client?     @relation(fields: [clientId], references: [id], onDelete: SetNull)
  creator User?       @relation("QuoteCreatedBy", fields: [createdBy], references: [id])
  items   QuoteItem[]
  invoice Invoice?

  @@unique([tenantId, quoteNumber])
  @@map("quotes")
}

model QuoteItem {
  id              String   @id @default(uuid())
  tenantId        String   @map("tenant_id")
  quoteId         String   @map("quote_id")
  productId       String?  @map("product_id")
  productSnapshot Json     @map("product_snapshot")
  quantity        Decimal  @db.Decimal(12, 3)
  unitPriceHtg    Decimal  @map("unit_price_htg") @db.Decimal(12, 2)
  unitPriceUsd    Decimal  @map("unit_price_usd") @db.Decimal(12, 2)
  discountPct     Decimal  @default(0) @map("discount_pct") @db.Decimal(5, 2)
  totalHtg        Decimal  @map("total_htg") @db.Decimal(14, 2)
  totalUsd        Decimal  @map("total_usd") @db.Decimal(14, 2)
  sortOrder       Int      @default(0) @map("sort_order")
  notes           String?
  createdAt       DateTime @default(now()) @map("created_at")

  tenant  Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  quote   Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  @@map("quote_items")
}

// ============================================================
// INVOICES (FACTURES)
// ============================================================

model Invoice {
  id               String        @id @default(uuid())
  tenantId         String        @map("tenant_id")
  invoiceNumber    String        @map("invoice_number") @db.VarChar(50)
  quoteId          String        @unique @map("quote_id")
  clientId         String?       @map("client_id")
  clientSnapshot   Json          @map("client_snapshot")
  currency         DefaultCurrency @default(HTG)
  exchangeRate     Decimal       @map("exchange_rate") @db.Decimal(10, 4)
  subtotalHtg      Decimal       @default(0) @map("subtotal_htg") @db.Decimal(14, 2)
  subtotalUsd      Decimal       @default(0) @map("subtotal_usd") @db.Decimal(14, 2)
  discountType     String        @default("amount") @map("discount_type") @db.VarChar(10)
  discountValue    Decimal       @default(0) @map("discount_value") @db.Decimal(10, 2)
  discountHtg      Decimal       @default(0) @map("discount_htg") @db.Decimal(14, 2)
  discountUsd      Decimal       @default(0) @map("discount_usd") @db.Decimal(14, 2)
  taxRate          Decimal       @default(0) @map("tax_rate") @db.Decimal(5, 2)
  taxHtg           Decimal       @default(0) @map("tax_htg") @db.Decimal(14, 2)
  taxUsd           Decimal       @default(0) @map("tax_usd") @db.Decimal(14, 2)
  totalHtg         Decimal       @default(0) @map("total_htg") @db.Decimal(14, 2)
  totalUsd         Decimal       @default(0) @map("total_usd") @db.Decimal(14, 2)
  amountPaidHtg    Decimal       @default(0) @map("amount_paid_htg") @db.Decimal(14, 2)
  amountPaidUsd    Decimal       @default(0) @map("amount_paid_usd") @db.Decimal(14, 2)
  balanceDueHtg    Decimal       @default(0) @map("balance_due_htg") @db.Decimal(14, 2)
  balanceDueUsd    Decimal       @default(0) @map("balance_due_usd") @db.Decimal(14, 2)
  status           InvoiceStatus @default(unpaid)
  issueDate        DateTime      @default(now()) @map("issue_date") @db.Date
  dueDate          DateTime?     @map("due_date") @db.Date
  notes            String?
  terms            String?
  stockDecremented Boolean       @default(false) @map("stock_decremented")
  createdBy        String?       @map("created_by")
  cancelledBy      String?       @map("cancelled_by")
  cancelledAt      DateTime?     @map("cancelled_at")
  cancelReason     String?       @map("cancel_reason")
  createdAt        DateTime      @default(now()) @map("created_at")
  updatedAt        DateTime      @updatedAt @map("updated_at")

  tenant    Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  quote     Quote         @relation(fields: [quoteId], references: [id])
  client    Client?       @relation(fields: [clientId], references: [id], onDelete: SetNull)
  creator   User?         @relation("InvoiceCreatedBy", fields: [createdBy], references: [id])
  canceller User?         @relation("InvoiceCancelledBy", fields: [cancelledBy], references: [id])
  items     InvoiceItem[]
  payments  Payment[]

  @@unique([tenantId, invoiceNumber])
  @@map("invoices")
}

model InvoiceItem {
  id              String   @id @default(uuid())
  tenantId        String   @map("tenant_id")
  invoiceId       String   @map("invoice_id")
  productId       String?  @map("product_id")
  productSnapshot Json     @map("product_snapshot")
  quantity        Decimal  @db.Decimal(12, 3)
  unitPriceHtg    Decimal  @map("unit_price_htg") @db.Decimal(12, 2)
  unitPriceUsd    Decimal  @map("unit_price_usd") @db.Decimal(12, 2)
  discountPct     Decimal  @default(0) @map("discount_pct") @db.Decimal(5, 2)
  totalHtg        Decimal  @map("total_htg") @db.Decimal(14, 2)
  totalUsd        Decimal  @map("total_usd") @db.Decimal(14, 2)
  stockBefore     Decimal? @map("stock_before") @db.Decimal(12, 3)
  stockAfter      Decimal? @map("stock_after") @db.Decimal(12, 3)
  sortOrder       Int      @default(0) @map("sort_order")
  notes           String?
  createdAt       DateTime @default(now()) @map("created_at")

  tenant  Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  invoice Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  @@map("invoice_items")
}

// ============================================================
// PAYMENTS
// ============================================================

model Payment {
  id          String        @id @default(uuid())
  tenantId    String        @map("tenant_id")
  invoiceId   String        @map("invoice_id")
  amountHtg   Decimal       @default(0) @map("amount_htg") @db.Decimal(14, 2)
  amountUsd   Decimal       @default(0) @map("amount_usd") @db.Decimal(14, 2)
  currency    DefaultCurrency @default(HTG)
  exchangeRate Decimal?     @map("exchange_rate") @db.Decimal(10, 4)
  method      PaymentMethod @default(cash)
  reference   String?       @db.VarChar(200)
  paymentDate DateTime      @default(now()) @map("payment_date") @db.Date
  notes       String?
  createdBy   String?       @map("created_by")
  createdAt   DateTime      @default(now()) @map("created_at")

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  creator User?   @relation(fields: [createdBy], references: [id])

  @@map("payments")
}

// ============================================================
// STOCK MOVEMENTS
// ============================================================

model StockMovement {
  id            String            @id @default(uuid())
  tenantId      String            @map("tenant_id")
  productId     String            @map("product_id")
  movementType  StockMovementType @map("movement_type")
  referenceId   String?           @map("reference_id")
  referenceType String?           @map("reference_type") @db.VarChar(50)
  quantityBefore Decimal         @map("quantity_before") @db.Decimal(12, 3)
  quantityChange Decimal         @map("quantity_change") @db.Decimal(12, 3)
  quantityAfter  Decimal         @map("quantity_after") @db.Decimal(12, 3)
  unitCostHtg   Decimal?         @map("unit_cost_htg") @db.Decimal(12, 2)
  notes         String?
  createdBy     String?           @map("created_by")
  createdAt     DateTime          @default(now()) @map("created_at")

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  creator User?   @relation(fields: [createdBy], references: [id])

  @@map("stock_movements")
}

// ============================================================
// DOCUMENT SEQUENCES
// ============================================================

model DocumentSequence {
  id           String   @id @default(uuid())
  tenantId     String   @map("tenant_id")
  documentType String   @map("document_type") @db.VarChar(20)
  prefix       String   @default("DOC") @db.VarChar(20)
  lastNumber   Int      @default(0) @map("last_number")
  yearReset    Boolean  @default(true) @map("year_reset")
  currentYear  Int      @default(2024) @map("current_year")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, documentType])
  @@map("document_sequences")
}

// ============================================================
// ACTIVITY LOGS
// ============================================================

model ActivityLog {
  id         String   @id @default(uuid())
  tenantId   String?  @map("tenant_id")
  userId     String?  @map("user_id")
  action     String   @db.VarChar(100)
  entityType String?  @map("entity_type") @db.VarChar(50)
  entityId   String?  @map("entity_id")
  oldData    Json?    @map("old_data")
  newData    Json?    @map("new_data")
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("activity_logs")
}

// ============================================================
// NOTIFICATIONS
// ============================================================

model Notification {
  id         String   @id @default(uuid())
  tenantId   String   @map("tenant_id")
  userId     String?  @map("user_id")
  type       String   @db.VarChar(50)
  titleHt    String?  @map("title_ht")
  titleFr    String?  @map("title_fr")
  titleEn    String?  @map("title_en")
  messageHt  String?  @map("message_ht")
  messageFr  String?  @map("message_fr")
  messageEn  String?  @map("message_en")
  entityType String?  @map("entity_type") @db.VarChar(50)
  entityId   String?  @map("entity_id")
  isRead     Boolean  @default(false) @map("is_read")
  readAt     DateTime? @map("read_at")
  createdAt  DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User?  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}
